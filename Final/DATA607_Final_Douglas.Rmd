---
title: "DATA 607 - Final Project"
author: "Adam Douglas"
date: "12/1/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
source("NYMap.R")
```

## Goal

The goal of this project is to look at rates of Opioid overdoses within New York state and compare to a variety of socioeconomic factors to see if there is a correlation between them.

## Introduction
The opioid crisis is bad, etc. Put some summary statistics here from other sources.

## Data Sources
### Overdose Deaths
New York State tracks opioid overdose deaths by county on their website[^1]. To get this data we need to scrape it from the site.

```{r scrape opioid data, message=FALSE}
library(rvest)
rawHTML <- read_html("https://www.health.ny.gov/statistics/opioid/data/d2.htm")
```

We can then parse it to get our data:
```{r parse opioid data}
# Get the table from the HTML
rawTable <- html_table(rawHTML)[[1]]

### Fix up the data frame ###
# Fix column names
colnames(rawTable) <- c("county","deaths_2013","deaths_2014",
                        "deaths_2015","total_deaths","avgPop",
                        "rate","adjRate")

# Remove region titles and region totals
opioids <- rawTable[-grep("[[:space:]]?Reg",rawTable$county),]
```

Now we need to tidy the data:
```{r tidy opioid}
# Put years into rows
opioids <- gather(opioids, key="year", value = "deaths",
                  deaths_2013, deaths_2014, deaths_2015)

opioids$year <- as.numeric(str_extract(opioids$year,"[0-9]+"))

# Standardize our counties
opioids$county <- tolower(opioids$county)
opioids$county <- str_replace(opioids$county,"\\.","")

# Fix column types
opioids$total_deaths <- as.numeric(str_replace_all(opioids$total_deaths,"(\\*|,)",""))
opioids$deaths <- as.numeric(str_replace_all(opioids$deaths,"(\\*|,)",""))
opioids$avgPop <- as.numeric(str_replace_all(opioids$avgPop,"(\\*|,)",""))
opioids$rate <- as.numeric(str_replace_all(opioids$rate,"(\\*|,)",""))
opioids$adjRate <- as.numeric(str_replace_all(opioids$adjRate,"(\\*|,)",""))
```

Let's look at what we have so far on a map:

```{r}
## Need to normalize the color scale for comparison across years
breaks <- c(0, seq(25,250,by=25))

opioids %>% filter(year == "2013") %>%
  NYMap("deaths","Opioid Overdose Deaths","2013",
        "Deaths\nPer 100,000", breaks)

opioids %>% filter(year == "2014") %>%
  NYMap("deaths","Opioid Overdose Deaths","2014",
        "Deaths\nPer 100,000", breaks)

opioids %>% filter(year == "2015") %>%
  NYMap("deaths","Opioid Overdose Deaths","2015",
        "Deaths\nPer 100,000", breaks)
```

There are a few counties which seem to have most of the overdose deaths.

### Unemployment Data
We get these data from NYS also[^2].

```{r get unemployment data, message=FALSE}
unemployment <- read_csv("NY_unemployment.csv")
unemployment
```

This data is already in a tidy format, so we don't need to do anything to it.

```{r}
breaks <- c(1, seq(2,12,by=1))

unemployment %>% filter(year == "2013") %>%
  NYMap("meanRate","Unemployment Rate","2013",
        "Rate", breaks)

unemployment %>% filter(year == "2014") %>%
  NYMap("meanRate","Unemployment Rate","2014",
        "Rate", breaks)

unemployment %>% filter(year == "2015") %>%
  NYMap("meanRate","Unemployment Rate","2015",
        "Rate", breaks)
```


###Poverty and Income Data
The Census Bureau gives us this data[^3].

```{r, message=FALSE}
rawPoverty <- read_csv(url("https://raw.githubusercontent.com/lysanthus/Data607/master/Final/poverty.csv"))

rawPoverty$county <- tolower(rawPoverty$county)

rawPoverty
```

First, we have several variables. In this analysis we will look at only poverty rate and median incomes for each county.

Secondly, we have data for 2013 and 2016 only. So we will have to linearly impute the middle values of 2014 and 2015 as equally distant from 2013 and 2016:

```{r}
# 2013 values
pov13 <- rawPoverty %>% filter(year == 2013) %>% select(county,pct = `All Ages in Poverty Percent`, inc = `Median Household Income in Dollars`)

# 2016 values
pov16 <- rawPoverty %>% filter(year == 2016) %>% select(county,pct = `All Ages in Poverty Percent`, inc = `Median Household Income in Dollars`)

# Fix income values by removing $ and ,
pov13$inc <- as.numeric(str_replace_all(pov13$inc,"\\$|,",""))
pov16$inc <- as.numeric(str_replace_all(pov16$inc,"\\$|,",""))

# Combine our data frames
poverty <- inner_join(pov13, pov16, by=c("county" = "county"),
                       suffix = c("_2013","_2016"))

# Compute changes and impute interim values
poverty <- poverty %>%
  mutate(povChg = pct_2016 - pct_2013, incChg = inc_2016 - inc_2013,
         povIncrement = povChg / 3, incIncrement = incChg / 3,
         pct_2014 = pct_2013 + povIncrement, pct_2015 = pct_2016 - povIncrement,
         inc_2014 = inc_2013 + incIncrement, inc_2015 = inc_2016 - incIncrement)

# Tidy the data
poverty <- poverty %>% 
  gather(key="year",
         value="value",
         pct_2013,pct_2014,pct_2015,pct_2016,
         inc_2013,inc_2014,inc_2015,inc_2016)

poverty <- poverty %>% separate(year,c("measure","yr"),"_")

poverty <- poverty %>% spread(key="measure",value="value") %>% select(county, year = yr, income = inc, poverty = pct)

poverty
```

## Analysis

```{r}
joint <- inner_join(opioids,unemployment,by=c("county" = "county","year" = "year"))
```

```{r}
joint %>% ggplot(aes(x=meanRate, y=deaths, col=as.factor(year))) +
  geom_point() + geom_smooth(method="lm", linetype=2, se=FALSE)
```


## Works Cited
[^1]: https://www.health.ny.gov/statistics/opioid/data/d2.htm
[^2]: https://data.ny.gov/Economic-Development/Local-Area-Unemployment-Statistics-Beginning-1976/5hyu-bdh8
[^3]: https://www.census.gov/data-tools/demo/saipe/saipe.html?s_appName=saipe&map_yearSelector=2013&map_geoSelector=aa_c&s_state=36&s_year=2016,2013
